# Ansible playbook для базовой настройки серверов, инсталляции кластера postgrespro и кластера 1С

playbook с набором ролей и групп серверов.

## Возможности

* Работа в ОС: CentOS (7, 8), Fedora (30, 31, 32);
* Базовая настройка серверов (прокси, обновления, базовые пакеты, базовый мониторинг, базовая безопасность и т.д.);
* Установка СУБД Postgrespro Standard;
* Установка сервера 1С.

## Установка и обновление

* Установить Python версии не ниже 3.8 (ниже версия не проверялась);
* Установить пакет ansible не ниже версии 2.8 из PyPI командой:
    ```sh
    pip install ansible
    ```
* Для обновления пакета необходимо воспользоваться командой:
    ```sh
    pip install -U ansible
    ```
* Установить пакет mitogen из PyPI командой:
    ```sh
    pip install mitogen
    ```

## Настройка playbook для selfhosted серверов
Обязательные настройки:
* `ansible.cfg` - настройка работы ansible при проигрывание playbook;
* `hosts` -  настройка файл inventory со списком серверов для проигрывания на них playbook;
* `ssh_pubkeys` -  настройка публичных ключей для их установки на сервера;
* `group_vars` -  настройка общих переменных для playbook.

### Настройка ansible.cfg
Для установки поведения ansible при проигрывание playbook необходимо в файле ansible.cfg:
* `strategy_plugins` - указать путь к плагину mitogen.

### Настройка hosts
В папке inventory переименоваить файл `hosts_template` в `hosts` и внести в него необходимые изменения:
* `server_hostname` - установить имя сервера, по которому сервера далее друг друга видить (прописывается в файл /etc/hosts);
* `ansible_host` - IPv4 адрес сервера, по которому ansible будет проигрывать playbook;
* `ansible_ssh_user` - пользователь ОС, под которым будут выполняться действия на сервере. Лучше использовать root. Иначе потребуется выполнять запуск playbook с ключом --become;
* `ansible_ssh_pass` - пароль пользователя ОС, под которым будут выполняться действия на сервере;
* `ansible_python_interpreter` - путь к интерпритатору Python в OC.

### Настройка ssh_pubkeys
В папку ssh_pubkeys необходимо поместить публичные ключи всех пользователей, которые будут создаваться на серверах. Наименования файлов должны иметь определенный формат: `username_key.pub`. К примеру: `ivanov_key.pub`

### Настройка group_vars 
В файле групповых переменных `inventory/group_vars/all.yml` необходимо настроить переменные:
* `users` - список пользователей, которые будут добавлены на сервера. Каждый элемент списка это также список (имя пользователя, оболчка и наименование файла публичного ключа пользователя);
* `langpack` - языковой пакет для установки на ОС;
* `LANG` - язык локализации ОС.

### Настройка main.yml
В файле `main.yml` для каждой группы серверов можно изменить состав ролей, которые будут к ним применены. Описание ролей представлено ниже.

## Запуск playbook
Для запуска проигрывания небходимо зайти в папку с плейбука, на уровень файла `main.yml`. Затем выполнить команду:
```sh
ansible-playbook main.yml
```
После запуска начнется процесс установки в соответствии со сделанными выше настройками.

## Роли playbook
Ниже описаны все роли, которые есть в playbook
### proxy
Настройка прокси сервера для оболочки, среды исполнения и менеджера пакетов
### hostname
Установка имени машины и заполнение файла /etc/hosts адресами и именами машин из inventory
### timezone
Установка временной зоны
### locale
Установка и настройка локали
### epel
Добавление репозитория Extra Packages for Enterprise Linux (EPEL)
### upgrade
Обновление всех пакетов в ОС
### cli-packages
Установка пакетов для удобной работы в оболочке zsh
### monitor-packages
Установка cli пакетов для локального мониторинга каждого сервера
### firewalld
Установка и базовая настройка брендмауэра
### groups
Создание группы администраторов серверов
### users
Добавление пользователей, ключей и включение в группы
### oh_my_zsh
Установка фреймворка оболочки zsh - [oh_my_zsh](https://github.com/ohmyzsh/ohmyzsh), а также становка дополнительных плагинов для oh_my_zsh:
* [zsh-autosuggestions](https://github.com/zsh-users/zsh-autosuggestions);
* [zsh-syntax-highlighting](https://github.com/zsh-users/zsh-syntax-highlighting);
* [powerlevel10k](https://github.com/romkatv/powerlevel10k) - для корретной работы необходимо установить дополнительные [шрифты](https://github.com/romkatv/powerlevel10k#meslo-nerd-font-patched-for-powerlevel10k) на локальную машину.
### config_omz
Настройка oh_my_zsh, плагинов и темы
### secure
Включение SELinux и установка инструмента анализа безопасности lynis
### sshd_basic
Включение в демоне sshd возможность подключаться по ключам
### sshd_nopass
Выключение в демоне sshd вход по паролям и вход под пользователея root
### docker
Установка docker
### docker-compose
Установка docker-compose
### remove-docker
Удаление установки docker
### postgrespro1c
Установка СУБД PostgresPro Standard, инициализация кластера и запуск службы
### app1c
Установка сервера 1С, инициализация кластера и запуск службы. Для этого требутеся в папку `app1c/files` посместить дистрбутив rpm 1С для linux, а также в файле `app1c/vars/main.yml` выполнить указание версии платформы
